var addAttackToGroup,addGroupToMap,addLeaderToGroup,addLinkToMap,addUmbrellaToMap,countVisibleGroups,englishDate,findDateOnTimeline,fitGroupToTimeline,fitGroups,fitUmbrella,fixGroupNames,getLinkType,getTimelineLabel,makeTimeline,numberToMonth,processDate,progressBar,setUpControls,setUpMapArea,setUpTimeline,settings,sizeLink,sizeLinksOnMap,zoomGeographic;settings={MIN_GROUP_WIDTH:60,MIN_YEAR_HEIGHT:13,SCROLL_BAR_WIDTH:30,ANIMATION_SPEED:400,ICON_ADJUST:-10,MIN_START_YEAR:1950,resolution_values:[10,5,1,0.5,0.25],year_height:0,startdate:0,enddate:0,zooms:[]};sizeLink=function(c){var a,e,b,d;if(!(c!=null)){return false}e=true;if($("#group-"+$(c).attr("data-group1")).position().left<$("#group-"+$(c).attr("data-group2")).position().left){b=$("#group-"+$(c).attr("data-group1"));d=$("#group-"+$(c).attr("data-group2"))}else{b=$("#group-"+$(c).attr("data-group2"));d=$("#group-"+$(c).attr("data-group1"));e=false}a=!e&&$(this).hasClass("spl")?5:0;return $(c).animate({left:b.position().left+Math.floor(b.width()/2)+a,width:d.position().left-b.position().left-($(c).hasClass("spl")?5:0)},settings.ANIMATION_SPEED)};fitUmbrella=function(j,f){var g,e,a,d,h,c,b;if(processDate($(j).attr("data-startdate"),"y")>settings.enddate||($(j).attr("data-enddate")!=="0000-00-00"&&processDate($(j).attr("data-enddate"),"y")<settings.startdate)){$(j).addClass("inactive");return false}g=$(j).attr("data-groups").split(",");d=Math.pow(2,53);h=0;e=0;for(a=0,b=g.length;0<=b?a<b:a>b;0<=b?a++:a--){if(!(g[a]!=null)||$("#group-"+g[a]).css("display")==="none"){continue}e+=1;d=Math.min(d,$("#group-"+g[a]).position().left);h=Math.max(h,$("#group-"+g[a]).position().left)}if(e<2){$(j).addClass("inactive");return false}$(j).removeClass("inactive");c=findDateOnTimeline($(j).attr("data-startdate"),f);$(j).css({left:d+parseInt($("div.group","#map_container").width()/2,10),width:h-d,top:c,height:findDateOnTimeline($(j).attr("data-enddate"),f)-c});return $(j).children("span").css({top:parseInt($(j).height()/2,10)-parseInt($(j).children("span").height()/2,10)})};sizeLinksOnMap=function(){if($(".group","#map_container").is(":animated")){return setTimeout(sizeLinksOnMap,settings.ANIMATION_SPEED)}else{$(".link","#map_container").each(function(){if($(this).css("display")!=="none"){return sizeLink(this)}});return $("div.umbrella","#map_container").each(function(){fitUmbrella($(this),settings.resolution_values[$("#time_zoom_slider").slider("value")]);return true})}};zoomGeographic=function(a){$(".group:not(.zoom-"+a+")","div#map_container").addClass("zoom_inactive");$(".link:not(.zoom-"+a+")","div#map_container").addClass("zoom_inactive");$("div.link.zoom-"+a,"#map_container").removeClass("zoom_inactive");$("div.group.zoom-"+a,"#map_container").removeClass("zoom_inactive");fitGroups(true,countVisibleGroups());return sizeLinksOnMap()};getLinkType=function(a){switch(a){case"all":return"Allies";case"spl":return"Split";case"aff":return"Affiliates";case"mer":return"Merge";case"riv":return"Rivals";default:return false}};addLinkToMap=function(c){var e,b,d,f,a;f=false;e="active-both";if($("#group-"+c.group1).position().left<$("#group-"+c.group2).position().left){f=true}if($("#group-"+c.group1).hasClass("active")&&$("#group-"+c.group2).hasClass("active")){e="active-active"}else{if($("#group-"+c.group1).hasClass("inactive")&&$("#group-"+c.group2).hasClass("inactive")){e="active-inactive"}}b=$("<div/>",{id:"link-"+c.id,"class":"link "+c.type+" group"+c.group1+" group"+c.group2+" "+e,css:{top:findDateOnTimeline(c.date)},"data-group1":c.group1,"data-group2":c.group2,"data-date":c.date,click:function(h){var g;g=this;if($(g).data("dialog_open")){return false}$(g).data("dialog_open",true);return $("<div/>",{html:processDate(c.date,"e")+": "+c.description}).dialog({modal:false,title:$("#group-"+c.group1).attr("data-shortname")+" and "+$("#group-"+c.group2).attr("data-shortname")+" "+getLinkType(c.type),width:300,"min-height":100,position:[h.pageX-$(window).scrollLeft()-150,h.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(g).data("dialog_open",false)}})}}).data("dialog_open",false);for(d=0,a=settings.zooms.length;0<=a?d<a:d>a;0<=a?d++:d--){if($("#group-"+c.group1).hasClass("zoom-"+d)&&$("#group-"+c.group2).hasClass("zoom-"+d)){b.addClass("zoom-"+d)}}if(c.type==="spl"){b.append($("<div/>",{"class":"split-icon"}));if(f){b.append($("<div/>",{"class":"split-right"}))}else{b.append($("<div/>",{"class":"split-left"}))}b.width(b.width()-5)}return $("#map_container").append(b)};getTimelineLabel=function(c,a){var b;if(a===0.5){return Math.floor(c)+" "+(Math.floor(c)===c?"Jan":"Jun")}else{if(a===0.25){switch(c-Math.floor(c)){case 0:b="Jan";break;case 0.25:b="Apr";break;case 0.5:b="Jul";break;case 0.75:b="Oct";break;default:b=false}return Math.floor(c)+" "+b}}return false};makeTimeline=function(d,e,g,m){var c,k,a,l,h,b,j,f;if(g==null){g=1}if(m==null){m=true}h=Math.floor((e-d)/g+1);c=$("<ul/>");for(a=d;d<=e?a<=e:a>=e;a+=g){if(g>1){l=a>e?e:a}else{if(g<1){l=getTimelineLabel(a,g)}else{l=a}}c.append($("<li/>",{text:l,id:"year-"+a}))}$("#timeline").empty().append(c);$("#timeline").height($(window).height()-$("#header").outerHeight()-($("#timeline").outerHeight()-$("#timeline").height())-settings.SCROLL_BAR_WIDTH);settings.year_height=Math.max(Math.floor(($("#timeline").height()/h)-$("li","#timeline").first().outerHeight()),settings.MIN_YEAR_HEIGHT);$("li","#timeline").css({"margin-bottom":settings.year_height});if($("#timeline").height()<$("ul","#timeline").height()){$("#timeline").height($("ul","#timeline").height())}if(m){f=$(".group","#map_container");for(b=0,j=f.length;b<j;b++){k=f[b];fitGroupToTimeline(k,g,d,e)}fitGroups(false,countVisibleGroups());$(".link","#map_container").each(function(){return $(this).animate({top:findDateOnTimeline($(this).attr("data-date"),g)},settings.ANIMATION_SPEED)});return sizeLinksOnMap()}};setUpTimeline=function(c,b){var a;a=$("<div/>",{id:"timeline",css:{top:$("#header").outerHeight()}});$("body").append(a);$(document).scroll(function(){return $("#timeline").css("left",-1*$("html").offset().left)});return makeTimeline(c,b,1,false)};addUmbrellaToMap=function(b){var a;a=$("<div/>",{"class":"umbrella",html:$("<span/>",{text:b.shortname}),"data-groups":b.groups.join(","),"data-startdate":b.startdate,"data-enddate":b.enddate,click:function(d){var c;if($(this).data("dialog_open")){return false}$(this).data("dialog_open",true);c=this;return $("<div/>",{html:b.description}).dialog({title:b.name,position:[d.pageX-$(window).scrollLeft()-150,d.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(c).data("dialog_open",false)}})}}).data("dialog_open",false);return $("#map_container").append(a)};setUpMapArea=function(j,h,e,k,m){var b,a,d,p,o,f,l,g,n,c;if(!(j!=null)||!(h!=null)){return false}b=$("<div/>",{id:"map_container",css:{left:$("#timeline").outerWidth(),top:$("#header").outerHeight()}});for(a=0,n=j.length;0<=n?a<n:a>n;0<=n?a++:a--){addGroupToMap(a,j[a],k,m,b)}$("body").append(b);fitGroups(false,j.length);$("div.group.active","#map_container").each(function(){return $(this).height($(this).height()+$("li","#timeline").first().outerHeight()+(parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH))});for(o=0,l=h.length;o<l;o++){d=h[o];addLinkToMap(d.Link)}$(".link.all, .link.riv","#map_container").each(function(){return $(this).append($("<div/>",{"class":"dot left"})).append($("<div/>",{"class":"dot right"}))});c=[];for(f=0,g=e.length;f<g;f++){p=e[f];c.push(addUmbrellaToMap(p))}return c};fixGroupNames=function(){return $("span",".group").each(function(){return $(this).css("margin-top",-1*$(this).outerHeight())})};fitGroups=function(a,b){var c;c=Math.max(Math.floor(($(window).width()-$("#timeline").outerWidth()-settings.SCROLL_BAR_WIDTH)/b),settings.MIN_GROUP_WIDTH);$("#map_container").width(b*c+settings.SCROLL_BAR_WIDTH);if(a){return $(".group","#map_container").animate({width:c},fixGroupNames)}else{$(".group","#map_container").width(c);return fixGroupNames()}};numberToMonth=function(a){switch(a){case 1:return"January";case 2:return"February";case 3:return"March";case 4:return"April";case 5:return"May";case 6:return"June";case 7:return"July";case 8:return"August";case 9:return"September";case 10:return"October";case 11:return"November";case 12:return"December";default:return false}};englishDate=function(a){if(!(a!=null)){return false}if(a[0]==="0000"){return"Unknown"}if(a[0]==="0001"){return"Current"}if(a[1]==="00"){return a[0]}else{return numberToMonth(parseInt(a[1],10))+" "+a[0]}};processDate=function(b,a){b=b.split("-");if(!(b instanceof Array)){return false}switch(a){case"y":return parseInt(b[0],10);case"m":return parseInt(b[1],10);case"d":return parseInt(b[2],10);case"e":return englishDate(b);default:return false}};findDateOnTimeline=function(d,a){var b,c,e;if(a==null){a=1}e=processDate(d,"y");c=processDate(d,"m");if(c===0){c=1}if(e===0){e=settings.enddate}if(e>settings.enddate){e=settings.enddate}if(e<settings.startdate){e=settings.startdate}if(a===1){b=e}else{if(a<1){b=Math.floor(e)}else{b=settings.startdate+Math.floor((e-settings.startdate)/a)*a}}return $("#year-"+b).position().top+((e-settings.startdate)%a)/a*($("li","#timeline").first().outerHeight()+settings.year_height)+Math.floor(c*(($("li","#timeline").first().outerHeight()+settings.year_height)/12))/a};fitGroupToTimeline=function(b,a,f,e,c){var d;if(c==null){c=true}if((processDate($(b).attr("data-enddate"),"y")<f&&processDate($(b).attr("data-enddate"),"y")!==0)||processDate($(b).attr("data-startdate"),"y")>e){$(b).addClass("timeline_inactive");$("div.link.group"+$(b).attr("id").substring(6)).addClass("timeline_inactive");return false}$(b).removeClass("timeline_inactive");$("div.link.group"+$(b).attr("id").substring(6)).removeClass("timeline_inactive");if(processDate($(b).attr("data-startdate"),"y")>=f){d=findDateOnTimeline($(b).attr("data-startdate"),a)}else{d=$("#year-"+f).position().top}$(b).animate({"margin-top":d,height:findDateOnTimeline($(b).attr("data-enddate"),a)-d+($(b).hasClass("active")?$("li","#timeline").first().outerHeight()+(parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH):0)},settings.ANIMATION_SPEED);return $(b).children("div").children(".attack, .leader").each(function(){return $(this).animate({top:findDateOnTimeline($(this).attr("data-date"),a)-d+settings.ICON_ADJUST},settings.ANIMATION_SPEED)})};addLeaderToGroup=function(a,g,c){var e,f,b,d;f=false;d=false;if(processDate(g.startdate,"y")!==0&&g.startdate!=="?"&&g.startdate.toLowerCase()!=="unknown"){e=g.startdate;d=true;if(g.enddate!=="?"&&g.enddate.toLowerCase()!=="unknown"){f=true}}else{if(processDate(g.enddate,"y")!==0){e=g.enddate;f=true}else{return false}}if(e==="?"||e.toLowerCase()==="unknown"){return false}b="<p>"+processDate(g.startdate,"e")+" - "+processDate(g.enddate,"e")+"</p><p>"+g.description+"</p>";return $(a).append($("<div/>",{"class":"leader",css:{top:Math.max(0,findDateOnTimeline(e)-c-settings.ICON_ADJUST)},"data-date":e,click:function(i){var h;h=this;if($(h).data("dialog_open")){return false}$(h).data("dialog_open",true);return $("<div/>",{html:b}).dialog({title:"Leadership Change: "+g.name,position:[i.pageX-$(window).scrollLeft()-150,i.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(h).data("dialog_open",false)}})}})).data("dialog_open",false)};addAttackToGroup=function(a,c,b){return $(a).append($("<div/>",{"class":"attack","data-date":c.date,css:{top:findDateOnTimeline(c.date)-b-settings.ICON_ADJUST},click:function(f){var d;d=this;if($(d).data("dialog_open")){return false}$(d).data("dialog_open",true);return $("<div/>",{html:"<p><b>"+processDate(c.date,"e")+":</b> "+c.description+(c.casualties!=null?" ("+c.casualties+")":"")+".</p>"}).dialog({title:"Major Attack",position:[f.pageX-$(window).scrollLeft()-150,f.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(d).data("dialog_open",false)}})}})).data("dialog_open",false)};addGroupToMap=function(s,f,p,b,r){var o,k,u,q,g,d,l,n,e,t,a,c,h,v,j,m;if(!(f!=null)||!(r!=null)){return false}q=f.Group;l=processDate(q.startdate,"y")>=p?q.startdate:p+"-00-00";n=findDateOnTimeline(l);u=$("<div/>",{"class":"group "+(processDate(q.enddate,"y")===0?"active":"inactive"),id:"group-"+q.id,css:{"margin-top":n,height:findDateOnTimeline(q.enddate)-n},"data-name":q.name,"data-shortname":q.shortname,"data-order":s,"data-startdate":l,"data-enddate":q.enddate,"data-id":q.id,html:$("<div/>",{"class":"group_timeline"})});h=f.Attack;for(e=0,a=h.length;e<a;e++){o=h[e];addAttackToGroup(u.children("div"),o,n)}v=f.Leader;for(t=0,c=v.length;t<c;t++){d=v[t];addLeaderToGroup(u.children("div"),d,n)}for(g=j=parseInt(q.min_zoom,10),m=parseInt(q.max_zoom,10);j<=m?g<=m:g>=m;j<=m?g++:g--){u.addClass("zoom-"+g)}k={};if(q.dummy===false){k["See Full Profile"]=function(){return window.open("/group/mappingmilitants/cgi-bin/groups/view/"+q.id)}}k["Trace Group"]=function(){var z,x,i,D,C,w,y,A,B;$("div.link:not(.group"+q.id+")","#map_container").addClass("trace_inactive");$("div.link.group"+q.id,"#map_container").removeClass("zoom_inactive");$("#group-"+q.id).removeClass("zoom_inactive").addClass("trace_active");B=$("div.link:not(.trace_inactive)","#map_container");for(C=0,y=B.length;C<y;C++){i=B[C];x=$(i).attr("class").split(" ");for(w=0,A=x.length;w<A;w++){z=x[w];if(z.indexOf("group")===-1){continue}if(z==="group"+q.id){continue}D=z.substring(5);$("#group-"+D).removeClass("zoom_inactive").addClass("trace_active")}}$("div.group:not(.trace_active)","#map_container").addClass("trace_inactive");fitGroups(true,countVisibleGroups());sizeLinksOnMap();$("#geo_zoom_slider,#geo_zoom_label").css("display","none");$("#stop_trace_button").css("display","inline").val("Stop Tracing "+q.shortname).click(function(){$("div.trace_active").removeClass("trace_active");$("div.trace_inactive").removeClass("trace_inactive");if(settings.zooms.length>1){$("#geo_zoom_slider,#geo_zoom_label").css("display","inline-block");zoomGeographic($("#geo_zoom_slider").slider("value"))}else{zoomGeographic(0)}return $(this).css("display","none")});return $(this).dialog("destroy").remove()};k.Close=function(){return $(this).dialog("destroy").remove()};u.prepend($("<span/>",{text:q.shortname,mouseenter:function(){var A,x,y,i,E,D,w,z,B,C;y=$(this).parent().data("id");$("div.link:not(.group"+y+")","#map_container").addClass("nav_inactive");C=$("div.link:not(.nav_inactive)","#map_container");for(D=0,z=C.length;D<z;D++){i=C[D];x=$(i).attr("class").split(" ");for(w=0,B=x.length;w<B;w++){A=x[w];if(A.indexOf("group")===-1){continue}if(A==="group"+y){continue}E=A.substring(5);$("#group-"+E).addClass("nav_active")}}$(this).parent().addClass("nav_active");$("div.group:not(.nav_active)","#map_container").addClass("nav_inactive");$(this).text(q.name).css({"background-color":"#A3B2FF","font-weight":"bold","font-size":"13px"});$(this).text(q.name).css({"margin-top":-1*$(this).outerHeight()});return $(this).parent().css("background-color","#D6E3FF")},mouseleave:function(){$(this).parent().css("background-color","transparent");$("div.link.nav_inactive").removeClass("nav_inactive");$("div.group.nav_inactive").removeClass("nav_inactive");$("div.group.nav_active").removeClass("nav_active");$(this).text(q.shortname).css({"background-color":"#fff","font-weight":"normal","font-size":"12px"});return $(this).text(q.shortname).css({"margin-top":-1*$(this).outerHeight()})},click:function(){return $("<div/>",{html:q.description}).dialog({title:q.name,modal:true,resizable:false,draggable:false,width:400,buttons:k})}}));return r.append(u)};progressBar=function(){var c,b,a;$("<div/>",{id:"progress_dialog",html:'<p>Please wait. The map is loading.</p><p>&nbsp;</p><div id="progress_bar"></div>',css:{height:10}}).dialog({modal:true,draggable:false,resizable:false,width:400,closeOnEscape:false,open:function(e,d){return $(".ui-dialog-titlebar-close").hide()}});$("#progress_bar").progressbar({value:20});b=function(){return $("#progress_bar").progressbar("value",$("#progress_bar").progressbar("value")+10)};a=[];for(c=1;c<=4;c++){a.push(setTimeout(b,500*(c+1)))}return a};countVisibleGroups=function(){var a,c,e,b,d;a=0;d=$("div.group","#map_container");for(e=0,b=d.length;e<b;e++){c=d[e];if($(c).css("display")!=="none"){a++}}return a};setUpControls=function(a){var b,c;if(!(a!=null)){return false}$("#legend_button").click(function(){return $("#legend_dialog").dialog({title:"Legend",width:220})});c=["Decade","5 Years","Year","6 Months","Quarter"];$("input.button").button();$("#settings_button").click(function(){return $("#settings_dialog").dialog({modal:true,width:600,draggable:false,resizable:false,title:"Map Settings"})});$("#both_radio").prop("checked",true);$("input[name=select_organizations]").change(function(){if($("input[name=select_organizations]:checked").val()==="both"){$("div.group","#map_container").removeClass("settings_inactive");$("div.link","#map_container").removeClass("group_activity_inactive")}else{$(".group:not(."+$("input[name=select_organizations]:checked").val()+")","div#map_container").addClass("settings_inactive");$(".link:not(.active-"+$("input[name=select_organizations]:checked").val()+")","#map_container").addClass("group_activity_inactive");$(".group."+$("input[name=select_organizations]:checked").val(),"div#map_container").removeClass("settings_inactive");$(".link.active-"+$("input[name=select_organizations]:checked").val(),"#map_container").removeClass("group_activity_inactive")}fitGroups(true,countVisibleGroups());return sizeLinksOnMap()});$(".toggle_checkbox").prop("checked",true).change(function(){if($(this).is(":checked")){$("."+$(this).attr("data-class"),"#map_container").removeClass("settings_inactive");return $("."+$(this).attr("data-class")+":not(.zoom_inactive)","#map_container").removeClass("settings_inactive").fadeIn(settings.ANIMATION_SPEED)}else{return $("."+$(this).attr("data-class"),"#map_container").addClass("settings_inactive").fadeOut(settings.ANIMATION_SPEED)}});$(".link_toggle_checkbox").prop("checked",true).change(function(){var d;d=$(this).attr("data-class");if($(this).is(":checked")){$("."+d,"#map_container").removeClass("settings_inactive");return sizeLinksOnMap()}else{return $("."+d,"#map_container").addClass("settings_inactive")}});if(a.length>1){$("#geo_zoom_slider").slider({value:0,min:0,max:a.length-1,slide:function(f,d){$("#geo_zoom_label").text("Geo Zoom: "+a[d.value].name);return zoomGeographic(d.value)}});$("#geo_zoom_label").text("Geo Zoom: "+a[0].name)}else{$("#geo_zoom_label").css({display:"none"})}$("#time_zoom_slider").slider({value:2,min:0,max:4,slide:function(f,d){$("#time_zoom_label").text("Timeline Resolution: "+c[d.value]);return makeTimeline(settings.startdate,settings.enddate,settings.resolution_values[d.value])}}).slider("value",2);$("#time_zoom_label").text("Timeline Resolution: Year");b=new Date();$("#timeline_selector").slider({range:true,min:settings.MIN_START_YEAR,max:b.getFullYear(),values:[settings.startdate,settings.enddate],slide:function(e,d){return $("#timeline_header").text("Timeline: "+d.values[0]+"-"+d.values[1])},change:function(e,d){settings.startdate=d.values[0];settings.enddate=d.values[1];return makeTimeline(settings.startdate,settings.enddate,settings.resolution_values[$("#time_zoom_slider").slider("value")])}});return $("#timeline_header").text("Timeline: "+settings.startdate+"-"+b.getFullYear())};