var addAttackToGroup,addGroupToMap,addLeaderToGroup,addLinkToMap,addUmbrellaToMap,countVisibleGroups,englishDate,findDateOnTimeline,fitGroupToTimeline,fitGroups,fitUmbrella,fixGroupNames,getLinkType,getTimelineLabel,makeTimeline,numberToMonth,processDate,progressBar,setUpControls,setUpMapArea,setUpTimeline,settings,sizeLink,sizeLinksOnMap,zoomGeographic;settings={MIN_GROUP_WIDTH:60,MIN_YEAR_HEIGHT:13,SCROLL_BAR_WIDTH:30,ANIMATION_SPEED:400,ICON_ADJUST:-10,MIN_START_YEAR:1950,resolution_values:[10,5,1,.5,.25],year_height:0,startdate:0,enddate:0,zooms:[],map_id:0};sizeLink=function(a){var b,c,d,e;if(!(a!=null)){return false}c=true;if($("#group-"+$(a).attr("data-group1")).position().left<$("#group-"+$(a).attr("data-group2")).position().left){d=$("#group-"+$(a).attr("data-group1"));e=$("#group-"+$(a).attr("data-group2"))}else{d=$("#group-"+$(a).attr("data-group2"));e=$("#group-"+$(a).attr("data-group1"));c=false}b=!c&&$(this).hasClass("spl")?5:0;return $(a).animate({left:d.position().left+Math.floor(d.width()/2)+b,width:e.position().left-d.position().left-($(a).hasClass("spl")?5:0)},settings.ANIMATION_SPEED)};fitUmbrella=function(a,b){var c,d,e,f,g,h,i,j;if(processDate($(a).attr("data-startdate"),"y")>settings.enddate||$(a).attr("data-enddate")!=="0000-00-00"&&processDate($(a).attr("data-enddate"),"y")<settings.startdate){$(a).addClass("inactive");return false}c=$(a).attr("data-groups").split(",");f=Math.pow(2,53);g=0;d=0;for(e=i=0,j=c.length;0<=j?i<j:i>j;e=0<=j?++i:--i){if(!(c[e]!=null)||$("#group-"+c[e]).css("display")==="none"){continue}d+=1;f=Math.min(f,$("#group-"+c[e]).position().left);g=Math.max(g,$("#group-"+c[e]).position().left)}if(d<2){$(a).addClass("inactive");return false}$(a).removeClass("inactive");h=findDateOnTimeline($(a).attr("data-startdate"),b);$(a).css({left:f+parseInt($("div.group","#map_container").width()/2,10),width:g-f,top:h,height:findDateOnTimeline($(a).attr("data-enddate"),b)-h});return $(a).children("span").css({top:parseInt($(a).height()/2,10)-parseInt($(a).children("span").height()/2,10)})};sizeLinksOnMap=function(){if($(".group","#map_container").is(":animated")){return setTimeout(sizeLinksOnMap,settings.ANIMATION_SPEED)}else{$(".link","#map_container").each(function(){if($(this).css("display")!=="none"){return sizeLink(this)}});return $("div.umbrella","#map_container").each(function(){fitUmbrella($(this),settings.resolution_values[$("#time_zoom_slider").slider("value")]);return true})}};zoomGeographic=function(a){$(".group:not(.zoom-"+a+")","div#map_container").addClass("zoom_inactive");$(".link:not(.zoom-"+a+")","div#map_container").addClass("zoom_inactive");$("div.link.zoom-"+a,"#map_container").removeClass("zoom_inactive");$("div.group.zoom-"+a,"#map_container").removeClass("zoom_inactive");fitGroups(true,countVisibleGroups());return sizeLinksOnMap()};getLinkType=function(a){switch(a){case"all":return"Allies";case"spl":return"Split";case"aff":return"Affiliates";case"mer":return"Merge";case"riv":return"Rivals";default:return false}};addLinkToMap=function(a){var b,c,d,e,f,g;e=false;b="active-both";if($("#group-"+a.group1).position().left<$("#group-"+a.group2).position().left){e=true}if($("#group-"+a.group1).hasClass("active")&&$("#group-"+a.group2).hasClass("active")){b="active-active"}else if($("#group-"+a.group1).hasClass("inactive")&&$("#group-"+a.group2).hasClass("inactive")){b="active-inactive"}c=$("<div/>",{id:"link-"+a.id,"class":"link "+a.type+" group"+a.group1+" group"+a.group2+" "+b,css:{top:findDateOnTimeline(a.date)},"data-group1":a.group1,"data-group2":a.group2,"data-date":a.date,click:linkClickFunction(a)}).data("dialog_open",false);for(d=f=0,g=settings.zooms.length;0<=g?f<g:f>g;d=0<=g?++f:--f){if($("#group-"+a.group1).hasClass("zoom-"+d)&&$("#group-"+a.group2).hasClass("zoom-"+d)){c.addClass("zoom-"+d)}}if(a.type==="spl"){c.append($("<div/>",{"class":"split-icon"}));if(e){c.append($("<div/>",{"class":"split-right"}))}else{c.append($("<div/>",{"class":"split-left"}))}c.width(c.width()-5)}return $("#map_container").append(c)};getTimelineLabel=function(a,b){if(b===.5){return Math.floor(a)===a?Math.floor(a)+" Jan":"Jun"}else if(b===.25){switch(a-Math.floor(a)){case 0:return Math.floor(a)+" Jan";case.25:return"Apr";case.5:return"Jul";case.75:return"Oct";default:return false}}return false};makeTimeline=function(a,b,c,d){var e,f,g,h,i,j,k,l,m;if(c==null){c=1}if(d==null){d=true}i=Math.floor((b-a)/c+1);e=$("<ul/>");for(g=j=a;a<=b?j<=b:j>=b;g=j+=c){if(c>1){h=g>b?b:g}else if(c<1){h=getTimelineLabel(g,c)}else{h=g}e.append($("<li/>",{text:h,id:"year-"+g}))}$("#timeline").empty().append(e);$("#timeline").height($(window).height()-$("#header").outerHeight()-($("#timeline").outerHeight()-$("#timeline").height())-settings.SCROLL_BAR_WIDTH);settings.year_height=Math.max(Math.floor($("#timeline").height()/i-$("li","#timeline").first().outerHeight()),settings.MIN_YEAR_HEIGHT);$("li","#timeline").css({"margin-bottom":settings.year_height});if($("#timeline").height()<$("ul","#timeline").height()){$("#timeline").height($("ul","#timeline").height())}if(d){m=$(".group","#map_container");for(k=0,l=m.length;k<l;k++){f=m[k];fitGroupToTimeline(f,c,a,b)}fitGroups(false,countVisibleGroups());$(".link","#map_container").each(function(){if(processDate($(this).data("date"),"y")<a||processDate($(this).data("date"),"y")>b){$(this).addClass("timeline_inactive")}else{$(this).removeClass("timeline_inactive")}return $(this).animate({top:findDateOnTimeline($(this).attr("data-date"),c)},settings.ANIMATION_SPEED)});return sizeLinksOnMap()}};setUpTimeline=function(a,b){var c;c=$("<div/>",{id:"timeline",css:{top:$("#header").outerHeight()}});$("body").append(c);$(document).scroll(function(){return $("#timeline").css("left",-1*$("html").offset().left)});return makeTimeline(a,b,1,false)};addUmbrellaToMap=function(a){var b;b=$("<div/>",{"class":"umbrella",html:$("<span/>",{text:a.shortname}),"data-groups":a.groups.join(","),"data-startdate":a.startdate,"data-enddate":a.enddate,click:function(b){var c;if($(this).data("dialog_open")){return false}$(this).data("dialog_open",true);c=this;return $("<div/>",{html:a.description}).dialog({title:a.name,position:[b.pageX-$(window).scrollLeft()-150,b.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(c).data("dialog_open",false)}})}}).data("dialog_open",false);return $("#map_container").append(b)};setUpMapArea=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p;if(!(a!=null)||!(b!=null)){return false}f=$("<div/>",{id:"map_container",css:{left:$("#timeline").outerWidth(),top:$("#header").outerHeight()}});for(g=j=0,o=a.length;0<=o?j<o:j>o;g=0<=o?++j:--j){addGroupToMap(g,a[g],d,e,f)}$("body").append(f);fitGroups(false,a.length);$("div.group.active","#map_container").each(function(){return $(this).height($(this).height()+$("li","#timeline").first().outerHeight()+(parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH))});for(k=0,m=b.length;k<m;k++){h=b[k];addLinkToMap(h.Link)}$(".link.all, .link.riv","#map_container").each(function(){return $(this).append($("<div/>",{"class":"dot left"})).append($("<div/>",{"class":"dot right"}))});p=[];for(l=0,n=c.length;l<n;l++){i=c[l];p.push(addUmbrellaToMap(i))}return p};fixGroupNames=function(){return $("span",".group").each(function(){return $(this).css("margin-top",-1*$(this).outerHeight())})};fitGroups=function(a,b){var c;c=Math.max(Math.floor(($(window).width()-$("#timeline").outerWidth()-settings.SCROLL_BAR_WIDTH)/b),settings.MIN_GROUP_WIDTH);$("#map_container").width(b*c+settings.SCROLL_BAR_WIDTH);if(a){return $(".group","#map_container").animate({width:c},fixGroupNames)}else{$(".group","#map_container").width(c);return fixGroupNames()}};numberToMonth=function(a){switch(a){case 1:return"January";case 2:return"February";case 3:return"March";case 4:return"April";case 5:return"May";case 6:return"June";case 7:return"July";case 8:return"August";case 9:return"September";case 10:return"October";case 11:return"November";case 12:return"December";default:return false}};englishDate=function(a){if(!(a!=null)){return false}if(a[0]==="0000"){return"Unknown"}if(a[0]==="0001"){return"Current"}if(a[1]==="00"){return a[0]}else{return numberToMonth(parseInt(a[1],10))+" "+a[0]}};processDate=function(a,b){a=a.split("-");if(!(a instanceof Array)){return false}switch(b){case"y":return parseInt(a[0],10);case"m":return parseInt(a[1],10);case"d":return parseInt(a[2],10);case"e":return englishDate(a);default:return false}};findDateOnTimeline=function(a,b){var c,d,e;if(b==null){b=1}e=processDate(a,"y");d=processDate(a,"m");if(d===0){d=1}if(e===0){e=settings.enddate}if(e>settings.enddate){e=settings.enddate}if(e<settings.startdate){e=settings.startdate}if(b===1){c=e}else if(b<1){c=Math.floor(e)}else{c=settings.startdate+Math.floor((e-settings.startdate)/b)*b}return $("#year-"+c).position().top+(e-settings.startdate)%b/b*($("li","#timeline").first().outerHeight()+settings.year_height)+Math.floor(d*(($("li","#timeline").first().outerHeight()+settings.year_height)/12))/b};fitGroupToTimeline=function(a,b,c,d,e){var f;if(e==null){e=true}if(processDate($(a).attr("data-enddate"),"y")<c&&processDate($(a).attr("data-enddate"),"y")!==0||processDate($(a).attr("data-startdate"),"y")>d){$(a).addClass("timeline_inactive");$("div.link.group"+$(a).attr("id").substring(6)).addClass("timeline_inactive");return false}$(a).removeClass("timeline_inactive");$("div.link.group"+$(a).attr("id").substring(6)).removeClass("timeline_inactive");if(processDate($(a).attr("data-startdate"),"y")>=c){f=findDateOnTimeline($(a).attr("data-startdate"),b)}else{f=$("#year-"+c).position().top}$(a).animate({"margin-top":f,height:findDateOnTimeline($(a).attr("data-enddate"),b)-f+($(a).hasClass("active")?$("li","#timeline").first().outerHeight()+(parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH):0)},settings.ANIMATION_SPEED);return $(a).children("div").children(".attack, .leader").each(function(){return $(this).animate({top:findDateOnTimeline($(this).attr("data-date"),b)-f+settings.ICON_ADJUST},settings.ANIMATION_SPEED)})};addLeaderToGroup=function(a,b,c){var d,e,f,g;e=false;g=false;if(processDate(b.startdate,"y")!==0&&b.startdate!=="?"&&b.startdate.toLowerCase()!=="unknown"){d=b.startdate;g=true;if(b.enddate!=="?"&&b.enddate.toLowerCase()!=="unknown"){e=true}}else if(processDate(b.enddate,"y")!==0){d=b.enddate;e=true}else{return false}if(d==="?"||d.toLowerCase()==="unknown"){return false}f="<p>"+processDate(b.startdate,"e")+" - "+processDate(b.enddate,"e")+"</p><p>"+b.description+"</p>";return $(a).append($("<div/>",{"class":"leader",css:{top:Math.max(0,findDateOnTimeline(d)-c-settings.ICON_ADJUST)},"data-date":d,click:function(a){var c;c=this;if($(c).data("dialog_open")){return false}$(c).data("dialog_open",true);return $("<div/>",{html:f}).dialog({title:"Leadership Change: "+b.name,position:[a.pageX-$(window).scrollLeft()-150,a.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(c).data("dialog_open",false)}})}})).data("dialog_open",false)};addAttackToGroup=function(a,b,c){return $(a).append($("<div/>",{"class":"attack","data-date":b.date,css:{top:findDateOnTimeline(b.date)-c-settings.ICON_ADJUST},click:function(a){var c;c=this;if($(c).data("dialog_open")){return false}$(c).data("dialog_open",true);return $("<div/>",{html:"<p><b>"+processDate(b.date,"e")+":</b> "+b.description+(b.casualties!=null?" ("+b.casualties+")":"")+".</p>"}).dialog({title:"Major Attack",position:[a.pageX-$(window).scrollLeft()-150,a.pageY-$(window).scrollTop()-70],beforeClose:function(){return $(c).data("dialog_open",false)}})}})).data("dialog_open",false)};addGroupToMap=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;if(!(b!=null)||!(e!=null)){return false}i=b.Group;l=processDate(i.startdate,"y")>=c?i.startdate:c+"-00-00";m=findDateOnTimeline(l);h=$("<div/>",{"class":"group "+(processDate(i.enddate,"y")===0?"active":"inactive"),id:"group-"+i.id,css:{"margin-top":m,height:findDateOnTimeline(i.enddate)-m},"data-name":i.name,"data-shortname":i.shortname,"data-order":a,"data-startdate":l,"data-enddate":i.enddate,"data-id":i.id,html:$("<div/>",{"class":"group_timeline"})});s=b.Attack;for(n=0,q=s.length;n<q;n++){f=s[n];if(f.date!=="0000-00-00"){addAttackToGroup(h.children("div"),f,m)}}t=b.Leader;for(o=0,r=t.length;o<r;o++){k=t[o];addLeaderToGroup(h.children("div"),k,m)}for(j=p=u=parseInt(i.min_zoom,10),v=parseInt(i.max_zoom,10);u<=v?p<=v:p>=v;j=u<=v?++p:--p){h.addClass("zoom-"+j)}g={};if(i.dummy===false){g["See Full Profile"]=function(){return window.open("/group/mappingmilitants/cgi-bin/groups/view/"+i.id)}}g["Trace Group"]=function(){var a,b,c,d,e,f,g,h,j;$("div.link:not(.group"+i.id+")","#map_container").addClass("trace_inactive");$("div.link.group"+i.id,"#map_container").removeClass("zoom_inactive");$("#group-"+i.id).removeClass("zoom_inactive").addClass("trace_active");j=$("div.link:not(.trace_inactive)","#map_container");for(e=0,f=j.length;e<f;e++){c=j[e];b=$(c).attr("class").split(" ");for(h=0,g=b.length;h<g;h++){a=b[h];if(a.indexOf("group")===-1){continue}if(a==="group"+i.id){continue}d=a.substring(5);$("#group-"+d).removeClass("zoom_inactive").addClass("trace_active")}}$("div.group:not(.trace_active)","#map_container").addClass("trace_inactive");fitGroups(true,countVisibleGroups());sizeLinksOnMap();$("#geo_zoom_slider,#geo_zoom_label").css("display","none");$("#stop_trace_button").css("display","inline").val("Stop Tracing "+i.shortname).click(function(){$("div.trace_active").removeClass("trace_active");$("div.trace_inactive").removeClass("trace_inactive");if(settings.zooms.length>1){$("#geo_zoom_slider,#geo_zoom_label").css("display","inline-block");zoomGeographic($("#geo_zoom_slider").slider("value"))}else{zoomGeographic(0)}return $(this).css("display","none")});return $(this).dialog("destroy").remove()};g["Close"]=function(){return $(this).dialog("destroy").remove()};h.prepend($("<span/>",{text:i.shortname,mouseenter:function(){var a,b,c,d,e,f,g,h,j,k;c=$(this).parent().data("id");$("div.link:not(.group"+c+")","#map_container").addClass("nav_inactive");k=$("div.link:not(.nav_inactive)","#map_container");for(f=0,g=k.length;f<g;f++){d=k[f];b=$(d).attr("class").split(" ");for(j=0,h=b.length;j<h;j++){a=b[j];if(a.indexOf("group")===-1){continue}if(a==="group"+c){continue}e=a.substring(5);$("#group-"+e).addClass("nav_active")}}$(this).parent().addClass("nav_active");$("div.group:not(.nav_active)","#map_container").addClass("nav_inactive");$(this).text(i.name).css({"background-color":"#A3B2FF","font-weight":"bold","font-size":"13px"});$(this).text(i.name).css({"margin-top":-1*$(this).outerHeight()});return $(this).parent().css("background-color","#D6E3FF")},mouseleave:function(){$(this).parent().css("background-color","transparent");$("div.link.nav_inactive").removeClass("nav_inactive");$("div.group.nav_inactive").removeClass("nav_inactive");$("div.group.nav_active").removeClass("nav_active");$(this).text(i.shortname).css({"background-color":"#fff","font-weight":"normal","font-size":"12px"});return $(this).text(i.shortname).css({"margin-top":-1*$(this).outerHeight()})},click:groupClickFunction(i,g)}));return e.append(h)};progressBar=function(){var a,b,c,d;$("<div/>",{id:"progress_dialog",html:'<p>Please wait. The map is loading.</p><p>&nbsp;</p><div id="progress_bar"></div>',css:{height:10}}).dialog({modal:true,draggable:false,resizable:false,width:400,closeOnEscape:false,open:function(a,b){return $(".ui-dialog-titlebar-close").hide()}});$("#progress_bar").progressbar({value:20});b=function(){return $("#progress_bar").progressbar("value",$("#progress_bar").progressbar("value")+10)};d=[];for(a=c=1;c<=4;a=++c){d.push(setTimeout(b,500*(a+1)))}return d};countVisibleGroups=function(){var a,b,c,d,e;a=0;e=$("div.group","#map_container");for(c=0,d=e.length;c<d;c++){b=e[c];if($(b).css("display")!=="none"){a++}}return a};setUpControls=function(a){var b,c;if(!(a!=null)){return false}$("#legend_button").click(function(){return $("#legend_dialog").dialog({title:"Legend",width:220})});c=["Decade","5 Years","Year","6 Months","Quarter"];$("input.button").button();$("#settings_button").click(function(){return $("#settings_dialog").dialog({modal:true,width:600,draggable:false,resizable:false,title:"Map Settings"})});$("#both_radio").prop("checked",true);$("input[name=select_organizations]").change(function(){if($("input[name=select_organizations]:checked").val()==="both"){$("div.group","#map_container").removeClass("settings_inactive");$("div.link","#map_container").removeClass("group_activity_inactive")}else{$(".group:not(."+$("input[name=select_organizations]:checked").val()+")","div#map_container").addClass("settings_inactive");$(".link:not(.active-"+$("input[name=select_organizations]:checked").val()+")","#map_container").addClass("group_activity_inactive");$(".group."+$("input[name=select_organizations]:checked").val(),"div#map_container").removeClass("settings_inactive");$(".link.active-"+$("input[name=select_organizations]:checked").val(),"#map_container").removeClass("group_activity_inactive")}fitGroups(true,countVisibleGroups());return sizeLinksOnMap()});$(".toggle_checkbox").prop("checked",true).change(function(){if($(this).is(":checked")){$("."+$(this).attr("data-class"),"#map_container").removeClass("settings_inactive");return $("."+$(this).attr("data-class")+":not(.zoom_inactive)","#map_container").removeClass("settings_inactive").fadeIn(settings.ANIMATION_SPEED)}else{return $("."+$(this).attr("data-class"),"#map_container").addClass("settings_inactive").fadeOut(settings.ANIMATION_SPEED)}});$(".link_toggle_checkbox").prop("checked",true).change(function(){var a;a=$(this).attr("data-class");if($(this).is(":checked")){$("."+a,"#map_container").removeClass("settings_inactive");return sizeLinksOnMap()}else{return $("."+a,"#map_container").addClass("settings_inactive")}});if(a.length>1){$("#geo_zoom_slider").slider({value:0,min:0,max:a.length-1,slide:function(b,c){$("#geo_zoom_label").text("Geo Zoom: "+a[c.value].name);return zoomGeographic(c.value)}});$("#geo_zoom_label").text("Geo Zoom: "+a[0].name)}else{$("#geo_zoom_label").css({display:"none"})}$("#time_zoom_slider").slider({value:2,min:0,max:4,slide:function(a,b){$("#time_zoom_label").text("Timeline Resolution: "+c[b.value]);return makeTimeline(settings.startdate,settings.enddate,settings.resolution_values[b.value])}}).slider("value",2);$("#time_zoom_label").text("Timeline Resolution: Year");b=new Date;$("#timeline_selector").slider({range:true,min:settings.MIN_START_YEAR,max:b.getFullYear(),values:[settings.startdate,settings.enddate],slide:function(a,b){return $("#timeline_header").text("Timeline: "+b.values[0]+"-"+b.values[1])},change:function(a,b){settings.startdate=b.values[0];settings.enddate=b.values[1];return makeTimeline(settings.startdate,settings.enddate,settings.resolution_values[$("#time_zoom_slider").slider("value")])}});return $("#timeline_header").text("Timeline: "+settings.startdate+"-"+b.getFullYear())}