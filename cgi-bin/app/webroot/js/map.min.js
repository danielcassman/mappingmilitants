var addAttackToGroup,addGroupToMap,addLeaderToGroup,addLinkToMap,countVisibleGroups,englishDate,findDateOnTimeline,fitGroupToTimeline,fitGroups,fixGroupNames,getLinkType,getTimelineLabel,makeTimeline,numberToMonth,processDate,progressBar,setUpControls,setUpMapArea,setUpTimeline,settings,sizeLink,sizeLinksOnMap,zoomGeographic;settings={MIN_GROUP_WIDTH:60,MIN_YEAR_HEIGHT:13,SCROLL_BAR_WIDTH:30,ANIMATION_SPEED:400,ICON_ADJUST:-10,MIN_START_YEAR:1950,resolution_values:[10,5,1,.5,.25],year_height:0,startdate:0,enddate:0,zooms:[]};sizeLink=function(a){var b,left_first,left_group,right_group;if(!(a!=null)){return false}left_first=true;if($("#group-"+$(a).attr("data-group1")).position().left<$("#group-"+$(a).attr("data-group2")).position().left){left_group=$("#group-"+$(a).attr("data-group1"));right_group=$("#group-"+$(a).attr("data-group2"))}else{left_group=$("#group-"+$(a).attr("data-group2"));right_group=$("#group-"+$(a).attr("data-group1"));left_first=false}b=!left_first&&$(this).hasClass("spl")?5:0;return $(a).animate({left:left_group.position().left+Math.floor(left_group.width()/2)+b,width:right_group.position().left-left_group.position().left-($(a).hasClass("spl")?5:0)},settings.ANIMATION_SPEED)};sizeLinksOnMap=function(){return setTimeout((function(){return $(".link","#map_container").each(function(){if($(this).css("display")!=="none"){return sizeLink(this)}})}),settings.ANIMATION_SPEED)};zoomGeographic=function(a){$(".group:not(.zoom-"+a+")","div#map_container").addClass("zoom_inactive");$(".link:not(.zoom-"+a+")","div#map_container").addClass("zoom_inactive");$("div.link.zoom-"+a,"#map_container").removeClass("zoom_inactive");$("div.group.zoom-"+a,"#map_container").removeClass("zoom_inactive");fitGroups(true,countVisibleGroups());return sizeLinksOnMap()};getLinkType=function(a){switch(a){case"all":return"Allies";case"spl":return"Split";case"aff":return"Affiliates";case"mer":return"Merge";case"riv":return"Rivals";default:return false}};addLinkToMap=function(a){var b,div,i,left_first,_ref;left_first=false;b="active-both";if($('#group-'+a.group1).position().left<$('#group-'+a.group2).position().left){left_first=true}if($('#group-'+a.group1).hasClass("active")&&$('#group-'+a.group2).hasClass("active")){b="active-active"}else if($('#group-'+a.group1).hasClass("inactive")&&$('#group-'+a.group2).hasClass("inactive")){b="active-inactive"}div=$("<div/>",{id:"link-"+a.id,"class":"link "+a.type+" group"+a.group1+" group"+a.group2+" "+b,css:{top:findDateOnTimeline(a.date)},"data-group1":a.group1,"data-group2":a.group2,"data-date":a.date,click:function(e){return $("<div/>",{html:processDate(a.date,"e")+": "+a.description}).dialog({modal:false,title:$('#group-'+a.group1).attr('data-shortname')+' and '+$('#group-'+a.group2).attr('data-shortname')+' '+getLinkType(a.type),width:300,"min-height":100,position:[e.pageX-$(window).scrollLeft()-150,e.pageY-$(window).scrollTop()-70]})}});for(i=0,_ref=settings.zooms.length;0<=_ref?i<=_ref:i>=_ref;0<=_ref?i++:i--){if($("#group-"+a.group1).hasClass("zoom-"+i)&&$("#group-"+a.group2).hasClass("zoom-"+i)){div.addClass("zoom-"+i)}}if(a.type==="spl"){div.append($("<div/>",{"class":"split-icon"}));if(left_first){div.append($("<div/>",{"class":"split-right"}))}else{div.append($("<div/>",{"class":"split-left"}))}div.width(div.width()-5)}return $("#map_container").append(div)};getTimelineLabel=function(a,b){var c;if(b===.5){return Math.floor(a)+" "+(Math.floor(a)===a?"Jan":"Jun")}else if(b===.25){switch(a-Math.floor(a)){case 0:c="Jan";break;case.25:c="Apr";break;case.5:c="Jul";break;case.75:c="Oct";break;default:c=false}return Math.floor(a)+" "+c}return false};makeTimeline=function(a,b,c,d){var e,group,i,label,num_ticks,_i,_len,_ref,_step;if(c==null){c=1}if(d==null){d=true}num_ticks=Math.floor((b-a)/c+1);e=$("<ul/>");for(i=a,_step=c;a<=b?i<=b:i>=b;i+=_step){if(c>1){label=i>b?b:i}else if(c<1){label=getTimelineLabel(i,c)}else{label=i}e.append($("<li/>",{text:label,id:"year-"+i}))}$("#timeline").empty().append(e);$("#wrap").height($(window).height()-$("#header").outerHeight());$("#timeline").height($("#wrap").height()-($("#timeline").outerHeight()-$("#timeline").height()));settings.year_height=Math.max(Math.floor(($("#timeline").height()/num_ticks)-$("li","#timeline").first().outerHeight()),settings.MIN_YEAR_HEIGHT);$("li","#timeline").css({"margin-bottom":settings.year_height});if($("#timeline").height()<$("ul","#timeline").height()){$("#timeline").height($("ul","#timeline").height())}$("#map_wrapper").height($("#timeline").outerHeight());$("#map_container").height($("#timeline").outerHeight()-parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH);if(d){_ref=$(".group","#map_container");for(_i=0,_len=_ref.length;_i<_len;_i++){group=_ref[_i];fitGroupToTimeline(group,c,a,b)}fitGroups(false,countVisibleGroups());$(".link","#map_container").each(function(){return $(this).animate({top:findDateOnTimeline($(this).attr("data-date"),c)},settings.ANIMATION_SPEED)});return sizeLinksOnMap()}};setUpTimeline=function(a,b){var c;c=$("<div/>",{id:"timeline"});$("#wrap").append(c);return makeTimeline(a,b,1,false)};setUpMapArea=function(a,b,c,d){var e,i,link,wrapper,_i,_len,_ref;if(!(a!=null)||!(b!=null)){return false}wrapper=$("<div/>",{id:"map_wrapper",css:{width:$(window).width()-$("#timeline").outerWidth()-settings.SCROLL_BAR_WIDTH,height:$("#timeline").outerHeight()}});e=$("<div/>",{id:"map_container",css:{height:$("#timeline").outerHeight()-parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH}});for(i=0,_ref=a.length-1;0<=_ref?i<=_ref:i>=_ref;0<=_ref?i++:i--){addGroupToMap(i,a[i].Profile,c,d,e)}$(wrapper).append(e);$("#wrap").append(wrapper);fitGroups(false,a.length);$("div.group.active","#map_container").each(function(){return $(this).height($(this).height()+$("li","#timeline").first().outerHeight()+(parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH))});for(_i=0,_len=b.length;_i<_len;_i++){link=b[_i];addLinkToMap(link.Link)}return $(".link.all, .link.riv","#map_container").each(function(){return $(this).append($("<div/>",{"class":"dot left"})).append($("<div/>",{"class":"dot right"}))})};fixGroupNames=function(){return $("span","#map_container").each(function(){return $(this).css("margin-top",-1*$(this).outerHeight())})};fitGroups=function(a,b){var c;c=Math.max(Math.floor(($(window).width()-$('#timeline').outerWidth()-settings.SCROLL_BAR_WIDTH)/b),settings.MIN_GROUP_WIDTH);$("#map_container").width(b*c);if(a){return $('.group','#map_container').animate({width:c},fixGroupNames)}else{$('.group','#map_container').width(c);return fixGroupNames()}};numberToMonth=function(m){switch(m){case 1:return"January";case 2:return"February";case 3:return"March";case 4:return"April";case 5:return"May";case 6:return"June";case 7:return"July";case 8:return"August";case 9:return"September";case 10:return"October";case 11:return"November";case 12:return"December";default:return false}};englishDate=function(d){if(!(d!=null)){return false}if(d[1]==="00"){return d[0]}else{return numberToMonth(parseInt(d[1],10))+" "+d[0]}};processDate=function(d,a){d=d.split("-");if(!(d instanceof Array)){return false}switch(a){case"y":return parseInt(d[0],10);case"m":return parseInt(d[1],10);case"d":return parseInt(d[2],10);case"e":return englishDate(d);default:return false}};findDateOnTimeline=function(a,b){var c,month,year;if(b==null){b=1}year=processDate(a,"y");if(year===0){year=settings.enddate}if(year>settings.enddate){year=settings.enddate}if(year<settings.startdate){year=settings.startdate}month=processDate(a,"m");if(month===0){month=1}if(b===1){c=year}else if(b<1){c=Math.floor(year)}else{c=settings.startdate+Math.floor((year-settings.startdate)/b)*b}return $("#year-"+c).position().top+((year-settings.startdate)%b)/b*($("li","#timeline").first().outerHeight()+settings.year_height)+Math.floor(month*(($("li","#timeline").first().outerHeight()+settings.year_height)/12))/b};fitGroupToTimeline=function(a,b,c,d,e){var f;if(e==null){e=true}if((processDate($(a).attr("data-enddate"),"y")<c&&processDate($(a).attr("data-enddate"),"y")!==0)||processDate($(a).attr("data-startdate"),"y")>d){$(a).addClass("timeline_inactive");$("div.link.group"+$(a).attr("id").substring(6)).addClass("timeline_inactive");return false}$(a).removeClass("timeline_inactive");$("div.link.group"+$(a).attr("id").substring(6)).removeClass("timeline_inactive");try{if(processDate($(a).attr("data-startdate"),"y")>=c){f=findDateOnTimeline($(a).attr("data-startdate"),b)}else{f=$("#year-"+c).position().top}$(a).animate({"margin-top":f,height:findDateOnTimeline($(a).attr("data-enddate"),b)-f+($(a).hasClass("active")?$("li","#timeline").first().outerHeight()+(parseInt($("#timeline").css("padding-bottom"),10)-settings.SCROLL_BAR_WIDTH):0)},settings.ANIMATION_SPEED);return $(a).children("div").children(".attack, .leader").each(function(){return $(this).animate({top:findDateOnTimeline($(this).attr("data-date"),b)-f+settings.ICON_ADJUST},settings.ANIMATION_SPEED)})}catch(error){return console.log($(a).attr("data-shortname"))}};addLeaderToGroup=function(a,b,c){var d,end,html,start;end=false;start=false;if(processDate(b.startdate,"y")!==0&&b.startdate!=="?"&&b.startdate.toLowerCase()!=="unknown"){d=b.startdate;start=true;if(b.enddate!=="?"&&b.enddate.toLowerCase()!=="unknown"){end=true}}else if(processDate(b.enddate,"y")!==0){d=b.enddate;end=true}else{return false}if(d==="?"||d.toLowerCase()==="unknown"){return false}if(start){html="<p>Assumed leadership "+processDate(b.startdate,"e")+".</p>";html+="<p>"+(b.enddate.toLowerCase()!=="unknown"&&b.enddate!=="?"?processDate(b.enddate,"e")+": ":"")+b.status+"</p>"}else{html="<p>"+processDate(b.enddate)+": "+b.status+"</p>"}return $(a).append($("<div/>",{"class":"leader",css:{top:Math.max(0,findDateOnTimeline(d)-c-settings.ICON_ADJUST)},"data-date":d,click:function(e){return $("<div/>",{html:html}).dialog({title:"Leadership Change: "+b.name,position:[e.pageX-$(window).scrollLeft()-150,e.pageY-$(window).scrollTop()-70]})}}))};addAttackToGroup=function(a,b,c){return $(a).append($("<div/>",{"class":"attack","data-date":b.date,css:{top:findDateOnTimeline(b.date)-c-settings.ICON_ADJUST},click:function(e){return $("<div/>",{html:"<p><b>"+processDate(b.date,"e")+":</b> "+b.description+(b.casualties!=null?" ("+b.casualties+")":"")+".</p>"}).dialog({title:"Major Attack",position:[e.pageX-$(window).scrollLeft()-150,e.pageY-$(window).scrollTop()-70]})}}))};addGroupToMap=function(a,b,d,e,f){var g,div,i,leader,start_year,top,_i,_j,_len,_len2,_ref,_ref2,_ref3,_ref4;if(!(b!=null)||!(f!=null)){return false}start_year=processDate(b.startdate,"y")>=d?b.startdate:d+"-00-00";top=findDateOnTimeline(start_year);div=$("<div/>",{"class":"group "+(processDate(b.enddate,'y')===0?"active":"inactive"),id:"group-"+b.id,css:{"margin-top":top,height:findDateOnTimeline(b.enddate)-top},"data-name":b.name,"data-shortname":b.shortname,"data-order":a,"data-startdate":start_year,"data-enddate":b.enddate,html:$("<div/>",{"class":"group_timeline"})});_ref=b.majorattacks;for(_i=0,_len=_ref.length;_i<_len;_i++){g=_ref[_i];addAttackToGroup(div.children("div"),g,top)}_ref2=b.leadership;for(_j=0,_len2=_ref2.length;_j<_len2;_j++){leader=_ref2[_j];addLeaderToGroup(div.children("div"),leader,top)}for(i=_ref3=parseInt(b.min_zoom,10),_ref4=parseInt(b.max_zoom,10);_ref3<=_ref4?i<=_ref4:i>=_ref4;_ref3<=_ref4?i++:i--){div.addClass("zoom-"+i)}div.prepend($("<span/>",{text:b.shortname,mouseenter:function(){return $(this).text(b.name).css("margin-top",-1*$(this).outerHeight())},mouseleave:function(){return $(this).text(b.shortname).css('margin-top',-1*$(this).outerHeight())},click:function(){return $("<div/>",{html:b.description}).dialog({title:b.name,modal:true,resizable:false,draggable:false,width:400,buttons:{"See Full Profile":function(){return window.open("/group/mappingmilitants/cgi-bin/profiles/view/"+b.id)},"Trace Group":function(){var c,class_attr,link,other_group,_k,_l,_len3,_len4,_ref5;$("div.link:not(.group"+b.id+")","#map_container").addClass("trace_inactive");$("div.link.group"+b.id,"#map_container").removeClass("zoom_inactive");$("#group-"+b.id).removeClass("zoom_inactive").addClass("trace_active");_ref5=$("div.link:not(.trace_inactive)","#map_container");for(_k=0,_len3=_ref5.length;_k<_len3;_k++){link=_ref5[_k];class_attr=$(link).attr("class").split(" ");for(_l=0,_len4=class_attr.length;_l<_len4;_l++){c=class_attr[_l];if(c.indexOf("group")===-1){continue}if(c==="group"+b.id){continue}other_group=c.substring(5);$("#group-"+other_group).removeClass("zoom_inactive").addClass("trace_active")}}$("div.group:not(.trace_active)","#map_container").addClass("trace_inactive");fitGroups(true,countVisibleGroups());sizeLinksOnMap();$("#geo_zoom_slider,#geo_zoom_label").css("display","none");$("#stop_trace_button").css("display","inline").val("Stop Tracing "+b.shortname).click(function(){$("div.trace_active").removeClass("trace_active");$("div.trace_inactive").removeClass("trace_inactive");$("#geo_zoom_slider,#geo_zoom_label").css("display","inline-block");$(this).css("display","none");return zoomGeographic($("#geo_zoom_slider").slider("value"))});return $(this).dialog("destroy").remove()},"Close":function(){return $(this).dialog("destroy").remove()}}})}}));return f.append(div)};progressBar=function(){var i,updateProgressBar,_results;$("<div/>",{id:"progress_dialog",html:'<p>Please wait. The map is loading.</p><p>&nbsp;</p><div id="progress_bar"></div>',css:{height:'10px'}}).dialog({modal:true,draggable:false,resizable:false,width:400,closeOnEscape:false,open:function(a,b){return $(".ui-dialog-titlebar-close").hide()}});$("#progress_bar").progressbar({value:20});updateProgressBar=function(){return $("#progress_bar").progressbar("value",$("#progress_bar").progressbar("value")+10)};_results=[];for(i=1;i<=4;i++){_results.push(setTimeout(updateProgressBar,500*(i+1)))}return _results};countVisibleGroups=function(){var a,group,_i,_len,_ref;a=0;_ref=$("div.group","#map_container");for(_i=0,_len=_ref.length;_i<_len;_i++){group=_ref[_i];if($(group).css("display")!=="none"){a++}}return a};setUpControls=function(c){var n,resolutions;if(!(c!=null)){return false}resolutions=["Decade","5 Years","Year","6 Months","Quarter"];$("input.button").button();$("#settings_button").click(function(){return $("#settings_dialog").dialog({modal:true,width:600,draggable:false,resizable:false,title:"Map Settings"})});$("input[name=select_organizations]").change(function(){if($("input[name=select_organizations]:checked").val()==="both"){$("div.group","#map_container").removeClass("settings_inactive");$("div.link","#map_container").removeClass("group_activity_inactive")}else{$(".group:not(."+$("input[name=select_organizations]:checked").val()+")","div#map_container").addClass("settings_inactive");$(".link:not(.active-"+$("input[name=select_organizations]:checked").val()+")","#map_container").addClass("group_activity_inactive");$(".group."+$("input[name=select_organizations]:checked").val(),"div#map_container").removeClass("settings_inactive");$(".link.active-"+$("input[name=select_organizations]:checked").val(),"#map_container").removeClass("group_activity_inactive")}fitGroups(true,countVisibleGroups());return sizeLinksOnMap()});$(".toggle_checkbox").prop("checked",true).change(function(){if($(this).is(":checked")){$("."+$(this).attr("data-class"),"#map_container").removeClass("settings_inactive");return $("."+$(this).attr("data-class")+":not(.zoom_inactive)","#map_container").removeClass("settings_inactive").fadeIn(settings.ANIMATION_SPEED)}else{return $("."+$(this).attr("data-class"),"#map_container").addClass("settings_inactive").fadeOut(settings.ANIMATION_SPEED)}});$(".link_toggle_checkbox").prop("checked",true).change(function(){var a;a=$(this).attr("data-class");if($(this).is(":checked")){$("."+a,"#map_container").removeClass("settings_inactive");return sizeLinksOnMap()}else{return $("."+a,"#map_container").addClass("settings_inactive")}});$("#geo_zoom_slider").slider({value:0,min:0,max:c.length-1,slide:function(e,a){$("#geo_zoom_label").text("Geo Zoom: "+c[a.value]);return zoomGeographic(a.value)}});$("#geo_zoom_label").text("Geo Zoom: "+c[0]);$("#time_zoom_slider").slider({value:2,min:0,max:4,slide:function(e,a){$("#time_zoom_label").text("Timeline Resolution: "+resolutions[a.value]);return makeTimeline(settings.startdate,settings.enddate,settings.resolution_values[a.value])}}).slider("value",2);$("#time_zoom_label").text("Timeline Resolution: Year");n=new Date();$("#timeline_selector").slider({range:true,min:settings.MIN_START_YEAR,max:n.getFullYear(),values:[settings.startdate,settings.enddate],slide:function(a,b){$("#timeline_header").text("Timeline: "+b.values[0]+"-"+b.values[1]);settings.startdate=b.values[0];settings.enddate=b.values[1];return makeTimeline(settings.startdate,settings.enddate,settings.resolution_values[$("#time_zoom_slider").slider("value")])}});return $("#timeline_header").text("Timeline: "+settings.startdate+"-"+n.getFullYear())};$(function(){$("body").height($(window).height());progressBar();return $.getJSON("/group/mappingmilitants/cgi-bin/maps/jsondata/3",function(a){$("#progress_bar").progressbar("value",70);settings.startdate=parseInt(a.Map.startyear,10);settings.enddate=parseInt(a.Map.endyear,10);settings.zooms=a.Map.zooms;setUpControls(settings.zooms);$("#progress_bar").progressbar("value",80);setUpTimeline(settings.startdate,settings.enddate);$("#progress_bar").progressbar("value",90);setUpMapArea(a.groups,a.links,settings.startdate,settings.enddate);$(".toggle_checkbox.start_unchecked").prop("checked",false).each(function(){return $("."+$(this).attr("data-class"),"#map_container").addClass("settings_inactive").fadeOut(settings.ANIMATION_SPEED)});$("#progress_bar").progressbar("value",100);$('#progress_dialog').delay(200).dialog('destroy');return zoomGeographic(0)})});